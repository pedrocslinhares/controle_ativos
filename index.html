<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Coletas</title>
    
    <!-- PWA Meta Tags -->
    <meta name="description" content="Sistema para controle e gerenciamento de coletas com m√∫ltiplos formul√°rios">
    <meta name="theme-color" content="#4f46e5">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Coletas">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- √çcones -->
    <link rel="icon" type="image/png" sizes="192x192" href="icons/icon-192x192.png">
    <link rel="apple-touch-icon" href="icons/icon-192x192.png">
    
    <!-- Fontes -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* Reset e Base */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            padding: 1rem;
        }

        .container {
            width: 100%;
            max-width: 900px;
            background-color: #ffffff;
            border-radius: 1rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
        }

        /* Tipografia */
        h1 {
            color: #1f2937;
            font-size: 1.875rem;
            font-weight: 700;
            text-align: center;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        h2 {
            color: #1f2937;
            font-size: 1.5rem;
            font-weight: 700;
            margin: 2rem 0 1rem;
        }

        h3 {
            color: #374151;
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        /* Formul√°rios */
        label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            color: #374151;
            margin-bottom: 0.25rem;
        }

        input, textarea, select {
            width: 100%;
            padding: 0.875rem;
            border: 1px solid #cbd5e1;
            border-radius: 0.625rem;
            font-size: 1rem;
            color: #1f2937;
            transition: all 0.2s;
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #4f46e5;
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.2);
        }

        textarea {
            resize: vertical;
            min-height: 80px;
        }

        /* Campo com input manual */
        .campo-combo {
            position: relative;
        }

        .input-manual {
            display: none;
            margin-top: 0.5rem;
        }

        .input-manual.visivel {
            display: block;
        }

        .input-manual input {
            border-color: #6366f1;
        }

        .label-manual {
            font-size: 0.75rem;
            color: #6366f1;
            margin-bottom: 0.25rem;
        }

        /* Autocomplete */
        .autocomplete-lista {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #e2e8f0;
            border-top: none;
            border-radius: 0 0 0.625rem 0.625rem;
            max-height: 200px;
            overflow-y: auto;
            z-index: 100;
            display: none;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .autocomplete-lista.visivel {
            display: block;
        }

        .autocomplete-item {
            padding: 0.75rem;
            cursor: pointer;
            transition: background 0.2s;
            font-size: 0.875rem;
        }

        .autocomplete-item:hover {
            background-color: #f0f4ff;
        }

        .autocomplete-item.selecionado {
            background-color: #e0e7ff;
        }

        .autocomplete-item .marca-badge {
            display: inline-block;
            padding: 0.125rem 0.375rem;
            background-color: #6366f1;
            color: white;
            border-radius: 0.25rem;
            font-size: 0.625rem;
            margin-left: 0.5rem;
        }

        /* Badge de frequ√™ncia */
        .freq-badge {
            display: inline-block;
            padding: 0.125rem 0.375rem;
            background-color: #10b981;
            color: white;
            border-radius: 0.25rem;
            font-size: 0.625rem;
            margin-left: 0.5rem;
        }

        /* Bot√µes */
        button {
            padding: 0.875rem 1.5rem;
            border: none;
            border-radius: 0.625rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }

        .btn-primary {
            background: linear-gradient(to right, #6366f1, #4f46e5);
            color: #ffffff;
        }

        .btn-secondary {
            background-color: #6b7280;
            color: #ffffff;
        }

        .btn-danger {
            background: linear-gradient(to right, #ef4444, #dc2626);
            color: #ffffff;
        }

        .btn-success {
            background: linear-gradient(to right, #34d399, #10b981);
            color: #ffffff;
        }

        .btn-sm {
            padding: 0.5rem 0.875rem;
            font-size: 0.8125rem;
            min-width: fit-content;
        }

        /* Grid do Formul√°rio */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
        }

        .form-grid .full-width {
            grid-column: 1 / -1;
        }

        .form-actions {
            grid-column: 1 / -1;
            display: flex;
            gap: 0.5rem;
            justify-content: flex-end;
            margin-top: 1.5rem;
        }

        /* Hub de Formul√°rios */
        .hub-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-top: 2rem;
        }

        .hub-card {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border: 2px solid #e2e8f0;
            border-radius: 1rem;
            padding: 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .hub-card:hover {
            border-color: #6366f1;
            transform: translateY(-4px);
            box-shadow: 0 12px 24px rgba(99, 102, 241, 0.15);
        }

        .hub-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(to right, #6366f1, #4f46e5);
            opacity: 0;
            transition: opacity 0.3s;
        }

        .hub-card:hover::before {
            opacity: 1;
        }

        .hub-card-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        .hub-card-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 0.5rem;
        }

        .hub-card-desc {
            font-size: 0.875rem;
            color: #6b7280;
            margin-bottom: 1rem;
        }

        .hub-card-stats {
            display: flex;
            gap: 1rem;
            font-size: 0.75rem;
            color: #9ca3af;
        }

        .hub-card-stat {
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        /* Menu Principal */
        .menu-principal {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-top: 2rem;
        }

        /* Lista de Coletas */
        .lista-coletas {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            margin-top: 1.5rem;
        }

        .item-coleta {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background-color: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 0.625rem;
            padding: 0.75rem 1rem;
            transition: all 0.2s;
        }

        .item-coleta:hover {
            background-color: #f0f4ff;
            border-color: #c7d2fe;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .item-coleta-nome {
            font-weight: 600;
            color: #1f2937;
        }

        .item-coleta-info {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .item-coleta-contador {
            color: #6b7280;
            font-size: 0.875rem;
            font-weight: 400;
        }

        .item-coleta-acoes {
            display: flex;
            gap: 0.375rem;
            flex-wrap: wrap;
            justify-content: flex-end;
            max-width: 60%;
        }

        /* Abas */
        .abas {
            display: flex;
            border-bottom: 1px solid #e2e8f0;
            margin-bottom: 1rem;
        }

        .aba {
            flex: 1;
            padding: 0.75rem 1rem;
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            color: #64748b;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .aba.ativa {
            color: #4f46e5;
            border-color: #4f46e5;
            font-weight: 700;
        }

        .aba:hover {
            color: #4f46e5;
        }

        /* Badge de Contagem */
        .badge-contador {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 2rem;
            height: 2rem;
            background-color: #4f46e5;
            color: white;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 700;
            padding: 0 0.5rem;
            margin-left: 0.5rem;
        }

        /* Tabela */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1.5rem;
            border-radius: 0.75rem;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        th, td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }

        th {
            background-color: #eef2ff;
            font-weight: 600;
            color: #334155;
        }

        tr:nth-child(even) {
            background-color: #f8fafc;
        }

        tr:hover {
            background-color: #f0f4ff;
        }

        .tabela-container {
            overflow-x: auto;
        }

        /* Mensagens */
        .mensagem {
            padding: 0.75rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            font-weight: 500;
            text-align: center;
            display: none;
        }

        .mensagem.sucesso {
            background-color: #d1fae5;
            color: #065f46;
            border: 1px solid #34d399;
        }

        .mensagem.erro {
            background-color: #fee2e2;
            color: #991b1b;
            border: 1px solid #ef4444;
        }

        .mensagem.visivel {
            display: block;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.4);
            justify-content: center;
            align-items: center;
        }

        .modal.ativo {
            display: flex;
        }

        .modal-conteudo {
            background-color: #ffffff;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            width: 90%;
            max-width: 400px;
            text-align: center;
            position: relative;
        }

        .modal-fechar {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 28px;
            font-weight: bold;
            color: #aaa;
            cursor: pointer;
        }

        .modal-fechar:hover {
            color: #000;
        }

        .modal-botoes {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        /* Status PWA */
        .status-pwa {
            position: fixed;
            top: 1rem;
            right: 1rem;
            padding: 0.5rem 1rem;
            border-radius: 2rem;
            font-size: 0.75rem;
            font-weight: 600;
            z-index: 1001;
            display: none;
        }

        .status-pwa.online {
            background: rgba(34, 197, 94, 0.9);
            color: white;
        }

        .status-pwa.offline {
            background: rgba(239, 68, 68, 0.9);
            color: white;
        }

        /* Prompt de Instala√ß√£o */
        .prompt-instalacao {
            position: absolute;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            display: none;
            align-items: center;
            justify-content: space-between;
        }

        .prompt-instalacao.visivel {
            display: flex;
        }

        /* CSV Output */
        .csv-container {
            margin-top: 1.5rem;
            padding: 1rem;
            background-color: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
        }

        .csv-textarea {
            width: 100%;
            background-color: #f3f4f6;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            padding: 0.5rem;
            font-size: 0.875rem;
            font-family: monospace;
        }

        /* Breadcrumb */
        .breadcrumb {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            color: #6b7280;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .breadcrumb-item {
            cursor: pointer;
            transition: color 0.2s;
        }

        .breadcrumb-item:hover {
            color: #4f46e5;
        }

        .breadcrumb-item.ativo {
            color: #1f2937;
            font-weight: 600;
            cursor: default;
        }

        .breadcrumb-separator {
            color: #d1d5db;
        }

        /* Utilit√°rios */
        .oculto {
            display: none !important;
        }

        .text-center {
            text-align: center;
        }

        .dica {
            font-size: 0.75rem;
            color: #6b7280;
            margin-top: 0.25rem;
            font-style: italic;
        }

        /* Responsivo */
        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }

            h1 {
                font-size: 1.5rem;
            }

            .form-actions {
                flex-direction: column-reverse;
            }

            .item-coleta {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.75rem;
                padding: 1rem;
            }

            .item-coleta-acoes {
                width: 100%;
                max-width: 100%;
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 0.5rem;
            }

            .item-coleta-acoes button {
                font-size: 0.75rem;
                padding: 0.5rem 0.75rem;
            }

            th, td {
                padding: 0.5rem;
                font-size: 0.875rem;
            }

            .hub-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Anima√ß√µes */
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        .msg-flutuante {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            animation: slideIn 0.3s ease-out;
        }
    </style>
</head>
<body>
    <!-- Status de Conex√£o PWA -->
    <div id="statusPWA" class="status-pwa">
        <span id="textoStatus">Online</span>
    </div>

    <!-- Prompt de Instala√ß√£o -->
    <div id="promptInstalacao" class="prompt-instalacao">
        <div>
            <strong>üì± Instalar App</strong>
            <div style="font-size: 0.875rem; margin-top: 0.25rem;">
                Adicione √† tela inicial para acesso r√°pido
            </div>
        </div>
        <div>
            <button id="btnInstalar" class="btn-secondary btn-sm">Instalar</button>
            <button id="btnFecharPrompt" class="btn-secondary btn-sm">‚úï</button>
        </div>
    </div>

    <div class="container">
        <!-- TELA HUB - Sele√ß√£o de Tipo de Formul√°rio -->
        <div id="telaHub" class="tela">
            <h1>üóÇÔ∏è Sistema de Coletas</h1>
            <p class="text-center" style="color: #6b7280; margin-bottom: 1rem;">
                Selecione o tipo de formul√°rio para iniciar
            </p>
            <div id="hubGrid" class="hub-grid"></div>
        </div>

        <!-- TELA PRINCIPAL - Menu do Formul√°rio Selecionado -->
        <div id="telaPrincipal" class="tela oculto">
            <div class="breadcrumb">
                <span class="breadcrumb-item" onclick="sistema.irParaHub()">üè† In√≠cio</span>
                <span class="breadcrumb-separator">‚Ä∫</span>
                <span id="breadcrumbTipo" class="breadcrumb-item ativo"></span>
            </div>
            
            <h1 id="tituloPrincipal"></h1>
            
            <div class="menu-principal">
                <button id="btnNovaColeta" class="btn-primary">
                    ‚ûï Criar Nova Coleta
                </button>
                <button id="btnListarColetas" class="btn-secondary">
                    üìÇ Acessar Coleta Existente
                </button>
            </div>
            
            <div style="display: flex; justify-content: center; margin-top: 2rem;">
                <button onclick="sistema.irParaHub()" class="btn-secondary">
                    ‚¨ÖÔ∏è Voltar ao In√≠cio
                </button>
            </div>
        </div>

        <!-- TELA LISTA DE COLETAS -->
        <div id="telaListaColetas" class="tela oculto">
            <div class="breadcrumb">
                <span class="breadcrumb-item" onclick="sistema.irParaHub()">üè† In√≠cio</span>
                <span class="breadcrumb-separator">‚Ä∫</span>
                <span class="breadcrumb-item" onclick="sistema.voltarPrincipal()" id="breadcrumbTipo2"></span>
                <span class="breadcrumb-separator">‚Ä∫</span>
                <span class="breadcrumb-item ativo">Coletas</span>
            </div>
            
            <h2 id="tituloListaColetas">üìã Suas Coletas</h2>
            <div id="listaColetas" class="lista-coletas"></div>
            <div style="display: flex; justify-content: center; margin-top: 2rem;">
                <button id="btnVoltarPrincipal" class="btn-secondary">
                    ‚¨ÖÔ∏è Voltar
                </button>
            </div>
        </div>

        <!-- TELA DADOS DA COLETA -->
        <div id="telaDadosColeta" class="tela oculto">
            <div class="breadcrumb">
                <span class="breadcrumb-item" onclick="sistema.irParaHub()">üè† In√≠cio</span>
                <span class="breadcrumb-separator">‚Ä∫</span>
                <span class="breadcrumb-item" onclick="sistema.voltarPrincipal()" id="breadcrumbTipo3"></span>
                <span class="breadcrumb-separator">‚Ä∫</span>
                <span class="breadcrumb-item" onclick="sistema.irParaListaColetas()" >Coletas</span>
                <span class="breadcrumb-separator">‚Ä∫</span>
                <span id="breadcrumbColeta" class="breadcrumb-item ativo"></span>
            </div>
            
            <h2 id="tituloColetaAtual"></h2>
            
            <div class="abas">
                <button id="abaFormulario" class="aba ativa">
                    üìù Registro
                </button>
                <button id="abaTabela" class="aba">
                    üìä Itens Registrados
                    <span id="contadorItens" class="badge-contador">0</span>
                </button>
            </div>

            <div id="mensagem" class="mensagem"></div>

            <!-- Conte√∫do do Formul√°rio - Renderizado Dinamicamente -->
            <div id="conteudoFormulario" class="conteudo-aba">
                <h3>‚ûï Adicionar Novo Item</h3>
                <form id="formularioCadastro" class="form-grid">
                    <!-- Campos ser√£o renderizados dinamicamente -->
                    <div id="camposFormulario"></div>
                    
                    <div class="form-actions">
                        <button type="button" id="btnLimparForm" class="btn-secondary">
                            üóëÔ∏è Limpar
                        </button>
                        <button type="submit" id="btnSalvarItem" class="btn-primary">
                            ‚ûï Adicionar Item
                        </button>
                    </div>
                </form>
            </div>

            <!-- Conte√∫do da Tabela -->
            <div id="conteudoTabela" class="conteudo-aba oculto">
                <h3>üìä Itens Registrados</h3>
                <div class="tabela-container">
                    <table>
                        <thead id="cabecalhoTabela">
                            <!-- Cabe√ßalho renderizado dinamicamente -->
                        </thead>
                        <tbody id="corpoTabela"></tbody>
                    </table>
                </div>

                <div style="display: flex; justify-content: center; gap: 1rem; margin-top: 2rem;">
                    <button id="btnExportarCSV" class="btn-success">
                        üì§ Exportar para CSV
                    </button>
                    <button id="btnLimparTodos" class="btn-danger">
                        üóëÔ∏è Limpar Todos os Itens
                    </button>
                </div>

                <div id="containerCSV" class="csv-container oculto">
                    <h3>üìÑ Dados CSV para Exporta√ß√£o:</h3>
                    <textarea id="textoCSV" class="csv-textarea" rows="10" readonly></textarea>
                    <p style="margin-top: 0.5rem; color: #6b7280; font-size: 0.875rem;">
                        Copie o texto acima e cole em uma planilha ou arquivo .csv
                    </p>
                    <div style="display: flex; justify-content: flex-end; gap: 0.5rem; margin-top: 0.75rem;">
                        <button id="btnCopiarCSV" class="btn-primary btn-sm">
                            üìã Copiar
                        </button>
                        <button id="btnBaixarCSV" class="btn-secondary btn-sm">
                            üíæ Baixar
                        </button>
                    </div>
                </div>
            </div>

            <!-- Navega√ß√£o -->
            <div style="display: flex; justify-content: center; gap: 1rem; margin-top: 2rem;">
                <button id="btnInicio" class="btn-secondary">
                    üè† IN√çCIO
                </button>
                <button id="btnTodasColetas" class="btn-secondary">
                    üìÇ TODAS COLETAS
                </button>
            </div>
        </div>
    </div>

    <!-- Modal √önico -->
    <div id="modal" class="modal">
        <div class="modal-conteudo">
            <span class="modal-fechar">&times;</span>
            <h3 id="modalTitulo">T√≠tulo</h3>
            <input type="text" id="modalInput" placeholder="Digite aqui" style="display: none; margin: 1rem 0;">
            <p id="modalMensagem" style="margin: 1rem 0;"></p>
            <div class="modal-botoes">
                <button id="modalBtnConfirmar" class="btn-primary">Confirmar</button>
                <button id="modalBtnCancelar" class="btn-secondary">Cancelar</button>
            </div>
        </div>
    </div>

    <script>
        // ===========================================================================
        // SISTEMA DE COLETAS MULTI-FORMUL√ÅRIO
        // ===========================================================================

        class SistemaColetas {
            constructor() {
                // Estado
                this.tipoAtual = null;
                this.colecaoAtual = null;
                this.dadosAtuais = [];
                this.indiceEdicao = -1;
                this.promptInstalacao = null;
                
                // Dados persistidos
                this.colecoes = {};          // { tipo: { nomeColeta: [itens] } }
                this.dadosPersonalizados = {}; // { tipo: { marca: [modelos] } }
                this.historico = {};          // { tipo: { setores: {}, locais: {} } }
                
                // Configura√ß√£o dos tipos de formul√°rio
                this.tiposFormulario = this.definirTiposFormulario();
                
                this.inicializar();
            }

            // ===========================================================================
            // DEFINI√á√ÉO DOS TIPOS DE FORMUL√ÅRIO
            // ===========================================================================
            
            definirTiposFormulario() {
                return {
                    equipamentos: {
                        id: 'equipamentos',
                        nome: 'Controle de Coletas de Equipamentos',
                        nomeResumido: 'Equipamentos',
                        icone: 'üìã',
                        descricao: 'Cadastro de gabinetes, notebooks, monitores e ramais',
                        cor: '#4f46e5',
                        
                        // Base de dados espec√≠fica
                        baseDados: {
                            MONITOR: {
                                'ASUS': ['MV16AMT'],
                                'ACER': ['X173W'],
                                'DELL': ['E157FP', 'E1910', 'E1914HC', 'P2422HE', 'ST2420L', 'U2413'],
                                'ITAUTEC': ['W1942PT'],
                                'AOC': ['E2023PWD', 'e2243Fwk', '22P2ES', '22P2WG5', '24E3QF', '24P1U', '24P1W1', '717wx'],
                                'POSITIVO': ['22MP55PJ-B', '24BL550J-B'],
                                'LENOVO': ['LS1920wG', 'T23i-10'],
                                'LG': ['22BN550Y-B'],
                                'DATEN': ['DM238V', '20M35PD-M'],
                                'HP': ['E190i', 'E201', 'E221', 'E243i', 'LA2006x', 'LA1905wg', 'V206hz', 'V223hz', 'V225hz', 'w17e', 'Z27q G3'],
                                'SAMSUNG': ['S19B300', 'S20B300', 'S24D332']
                            },
                            GABINETE: {
                                'HP': ['Compaq Pro 6305', 'Compaq 6005 Pro'],
                                'ITAUTEC': ['SM3322'],
                                'DATEN': ['DC1C-S', 'DC3D-U', 'DC6A-U', 'DC6E-S'],
                                'LENOVO': ['P330'],
                                'POSITIVO': ['C4400', 'C6200', 'C6400']
                            },
                            NOTEBOOK: {
                                'DELL': [], 'HP': [], 'LENOVO': [], 'ASUS': [],
                                'ACER': [], 'POSITIVO': [], 'SAMSUNG': []
                            },
                            RAMAL: {}
                        },
                        
                        // Defini√ß√£o dos campos
                        campos: [
                            {
                                id: 'tipo',
                                label: 'TIPO',
                                tipo: 'select',
                                obrigatorio: true,
                                opcoes: ['GABINETE', 'NOTEBOOK', 'MONITOR', 'RAMAL'],
                                gatilho: 'atualizarMarcas' // A√ß√£o especial ao mudar
                            },
                            {
                                id: 'marca',
                                label: 'MARCA',
                                tipo: 'select-dinamico',
                                obrigatorio: true,
                                dependeDe: 'tipo',
                                permitirOutro: true
                            },
                            {
                                id: 'modelo',
                                label: 'MODELO',
                                tipo: 'select-dinamico',
                                obrigatorio: false,
                                dependeDe: 'marca',
                                permitirOutro: true
                            },
                            {
                                id: 'numeroSerie',
                                label: 'N√öMERO DE S√âRIE',
                                tipo: 'text',
                                obrigatorio: false
                            },
                            {
                                id: 'patrimonioSiads',
                                label: 'PAT. SIADS',
                                tipo: 'number',
                                obrigatorio: false
                            },
                            {
                                id: 'patrimonioEbserh',
                                label: 'PAT. EBSERH',
                                tipo: 'number',
                                obrigatorio: false
                            },
                            {
                                id: 'patrimonioFub',
                                label: 'PAT. FUB',
                                tipo: 'text',
                                obrigatorio: false
                            },
                            {
                                id: 'predio',
                                label: 'PR√âDIO',
                                tipo: 'select',
                                obrigatorio: true,
                                opcoes: ['ADMINISTRA√á√ÉO', 'UNIDADE 1', 'UNIDADE 2', 'UCA', 
                                         'AMBULAT√ìRIO 1', 'AMBULAT√ìRIO 2', 'UNACON', 'SIF', 'SEGURAN√áA']
                            },
                            {
                                id: 'andar',
                                label: 'ANDAR',
                                tipo: 'select',
                                obrigatorio: true,
                                opcoes: ['CPA', 'SUBSOLO', 'T√âRREO', '1', '2', '3', '4']
                            },
                            {
                                id: 'setor',
                                label: 'SETOR',
                                tipo: 'select-historico',
                                obrigatorio: true,
                                permitirOutro: true,
                                historicoKey: 'setores'
                            },
                            {
                                id: 'local',
                                label: 'LOCAL',
                                tipo: 'select-historico',
                                obrigatorio: true,
                                permitirOutro: true,
                                historicoKey: 'locais'
                            },
                            {
                                id: 'vinculo',
                                label: 'V√çNCULO',
                                tipo: 'number',
                                obrigatorio: false,
                                placeholder: 'N¬∫ patrim√¥nio do computador',
                                dica: 'üí° Para MONITOR/RAMAL: informe o PAT do computador vinculado'
                            },
                            {
                                id: 'observacao',
                                label: 'OBSERVA√á√ÉO',
                                tipo: 'textarea',
                                obrigatorio: false,
                                fullWidth: true
                            }
                        ],
                        
                        // Colunas da tabela (exporta√ß√£o e visualiza√ß√£o)
                        colunas: [
                            { id: 'tipo', label: 'Tipo' },
                            { id: 'marca', label: 'Marca' },
                            { id: 'modelo', label: 'Modelo' },
                            { id: 'numeroSerie', label: 'N¬∫ de S√©rie' },
                            { id: 'patrimonioSiads', label: 'PAT. SIADS' },
                            { id: 'patrimonioEbserh', label: 'PAT. EBSERH' },
                            { id: 'patrimonioFub', label: 'PAT. FUB' },
                            { id: 'predio', label: 'Pr√©dio' },
                            { id: 'andar', label: 'Andar' },
                            { id: 'setor', label: 'Setor' },
                            { id: 'local', label: 'Local' },
                            { id: 'vinculo', label: 'V√≠nculo' },
                            { id: 'observacao', label: 'Observa√ß√£o' }
                        ],
                        
                        // Valida√ß√£o customizada
                        validarItem: (item) => {
                            const patrimonios = [item.numeroSerie, item.patrimonioSiads, 
                                                item.patrimonioEbserh, item.patrimonioFub];
                            if (!patrimonios.some(p => p && p !== '')) {
                                return { valido: false, erro: 'Informe pelo menos um n√∫mero de patrim√¥nio' };
                            }
                            return { valido: true };
                        }
                    }
                    
                    // Adicione outros tipos aqui conforme necess√°rio
                    // Exemplo:
                    // moveis: { ... }
                    // veiculos: { ... }
                };
            }

            // ===========================================================================
            // INICIALIZA√á√ÉO
            // ===========================================================================
            
            inicializar() {
                this.carregarDados();
                this.migrarDadosLegados();
                this.configurarEventosGlobais();
                this.configurarPWA();
                this.renderizarHub();
                this.mostrarTela('telaHub');
            }

            // ===========================================================================
            // ARMAZENAMENTO E MIGRA√á√ÉO
            // ===========================================================================
            
            carregarDados() {
                try {
                    // Carregar cole√ß√µes
                    const colecoes = localStorage.getItem('sistemaColecoesV2');
                    if (colecoes) {
                        this.colecoes = JSON.parse(colecoes);
                    }
                    
                    // Carregar dados personalizados
                    const personalizados = localStorage.getItem('sistemaPersonalizadosV2');
                    if (personalizados) {
                        this.dadosPersonalizados = JSON.parse(personalizados);
                    }
                    
                    // Carregar hist√≥rico
                    const historico = localStorage.getItem('sistemaHistoricoV2');
                    if (historico) {
                        this.historico = JSON.parse(historico);
                    }
                } catch (erro) {
                    console.error('Erro ao carregar dados:', erro);
                }
            }

            migrarDadosLegados() {
                // Migrar dados do formato antigo (v1) para o novo (v2)
                try {
                    const dadosAntigos = localStorage.getItem('allEquipmentCollections');
                    if (dadosAntigos && !this.colecoes.equipamentos) {
                        const parsed = JSON.parse(dadosAntigos);
                        
                        this.colecoes.equipamentos = {};
                        
                        for (let nomeColeta in parsed) {
                            if (Array.isArray(parsed[nomeColeta])) {
                                this.colecoes.equipamentos[nomeColeta] = parsed[nomeColeta].map(item => {
                                    // Normalizar campos
                                    const itemNovo = {
                                        tipo: item.type === 'MINIPC' ? 'GABINETE' : item.type,
                                        marca: item.brand || '',
                                        modelo: item.model || '',
                                        numeroSerie: item.serialNumber || '',
                                        patrimonioSiads: item.patSiads || '',
                                        patrimonioEbserh: item.patEbserh || '',
                                        patrimonioFub: item.patFub || '',
                                        predio: item.building || '',
                                        andar: item.floor || '',
                                        setor: item.setor || (item.sector ? item.sector.split(/[-/,]/)[0]?.trim() : ''),
                                        local: item.local || (item.sector ? item.sector.split(/[-/,]/)[1]?.trim() : ''),
                                        vinculo: item.vinculo || item.user || '',
                                        observacao: item.observation || ''
                                    };
                                    return itemNovo;
                                });
                            }
                        }
                        
                        this.salvarDados();
                        console.log('Migra√ß√£o de dados legados conclu√≠da');
                    }
                    
                    // Migrar hist√≥rico antigo
                    const historicoAntigo = localStorage.getItem('locationHistory');
                    if (historicoAntigo && !this.historico.equipamentos) {
                        this.historico.equipamentos = JSON.parse(historicoAntigo);
                        this.salvarHistorico();
                    }
                    
                    // Migrar dados personalizados antigos
                    const persAntigo = localStorage.getItem('equipmentCustomData');
                    if (persAntigo && !this.dadosPersonalizados.equipamentos) {
                        this.dadosPersonalizados.equipamentos = JSON.parse(persAntigo);
                        this.salvarDadosPersonalizados();
                    }
                } catch (erro) {
                    console.error('Erro na migra√ß√£o:', erro);
                }
            }

            salvarDados() {
                try {
                    localStorage.setItem('sistemaColecoesV2', JSON.stringify(this.colecoes));
                } catch (erro) {
                    console.error('Erro ao salvar:', erro);
                    this.mostrarMensagem('Erro ao salvar dados', 'erro');
                }
            }

            salvarDadosPersonalizados() {
                localStorage.setItem('sistemaPersonalizadosV2', JSON.stringify(this.dadosPersonalizados));
            }

            salvarHistorico() {
                localStorage.setItem('sistemaHistoricoV2', JSON.stringify(this.historico));
            }

            // ===========================================================================
            // NAVEGA√á√ÉO
            // ===========================================================================
            
            mostrarTela(idTela) {
                document.querySelectorAll('.tela').forEach(tela => tela.classList.add('oculto'));
                document.getElementById(idTela).classList.remove('oculto');
                
                if (idTela === 'telaDadosColeta') {
                    this.mostrarAba('formulario');
                }
            }

            irParaHub() {
                this.tipoAtual = null;
                this.colecaoAtual = null;
                this.mostrarTela('telaHub');
            }

            voltarPrincipal() {
                this.colecaoAtual = null;
                this.mostrarTela('telaPrincipal');
            }

            irParaListaColetas() {
                this.renderizarListaColecoes();
                this.mostrarTela('telaListaColetas');
            }

            selecionarTipo(tipoId) {
                this.tipoAtual = tipoId;
                const tipo = this.tiposFormulario[tipoId];
                
                // Atualizar t√≠tulos
                document.getElementById('tituloPrincipal').innerHTML = `${tipo.icone} ${tipo.nome}`;
                document.getElementById('breadcrumbTipo').textContent = tipo.nomeResumido;
                document.getElementById('breadcrumbTipo2').textContent = tipo.nomeResumido;
                document.getElementById('breadcrumbTipo3').textContent = tipo.nomeResumido;
                document.getElementById('tituloListaColetas').innerHTML = `üìã Coletas de ${tipo.nomeResumido}`;
                
                // Inicializar estruturas se n√£o existirem
                if (!this.colecoes[tipoId]) this.colecoes[tipoId] = {};
                if (!this.dadosPersonalizados[tipoId]) this.dadosPersonalizados[tipoId] = {};
                if (!this.historico[tipoId]) this.historico[tipoId] = { setores: {}, locais: {} };
                
                this.mostrarTela('telaPrincipal');
            }

            mostrarAba(aba) {
                const abaForm = document.getElementById('abaFormulario');
                const abaTab = document.getElementById('abaTabela');
                const conteudoForm = document.getElementById('conteudoFormulario');
                const conteudoTab = document.getElementById('conteudoTabela');
                
                if (aba === 'formulario') {
                    abaForm.classList.add('ativa');
                    abaTab.classList.remove('ativa');
                    conteudoForm.classList.remove('oculto');
                    conteudoTab.classList.add('oculto');
                } else {
                    abaForm.classList.remove('ativa');
                    abaTab.classList.add('ativa');
                    conteudoForm.classList.add('oculto');
                    conteudoTab.classList.remove('oculto');
                    this.renderizarTabela();
                }
            }

            // ===========================================================================
            // RENDERIZA√á√ÉO DO HUB
            // ===========================================================================
            
            renderizarHub() {
                const grid = document.getElementById('hubGrid');
                grid.innerHTML = '';
                
                for (let tipoId in this.tiposFormulario) {
                    const tipo = this.tiposFormulario[tipoId];
                    const qtdColetas = Object.keys(this.colecoes[tipoId] || {}).length;
                    const qtdItens = Object.values(this.colecoes[tipoId] || {})
                        .reduce((acc, arr) => acc + arr.length, 0);
                    
                    const card = document.createElement('div');
                    card.className = 'hub-card';
                    card.onclick = () => this.selecionarTipo(tipoId);
                    card.innerHTML = `
                        <div class="hub-card-icon">${tipo.icone}</div>
                        <div class="hub-card-title">${tipo.nomeResumido}</div>
                        <div class="hub-card-desc">${tipo.descricao}</div>
                        <div class="hub-card-stats">
                            <span class="hub-card-stat">üìÅ ${qtdColetas} coletas</span>
                            <span class="hub-card-stat">üìÑ ${qtdItens} itens</span>
                        </div>
                    `;
                    grid.appendChild(card);
                }
            }

            // ===========================================================================
            // COLE√á√ïES
            // ===========================================================================
            
            async criarColecao() {
                const nome = await this.abrirModalInput('Nova Coleta', 'Nome da coleta:');
                if (!nome) return;
                
                if (this.colecoes[this.tipoAtual][nome]) {
                    this.mostrarMensagem('J√° existe uma coleta com este nome', 'erro');
                    return;
                }
                
                this.colecoes[this.tipoAtual][nome] = [];
                this.salvarDados();
                this.abrirColecao(nome);
                this.mostrarMensagem(`Coleta "${nome}" criada com sucesso!`);
            }

            abrirColecao(nome) {
                this.colecaoAtual = nome;
                this.dadosAtuais = this.colecoes[this.tipoAtual][nome] || [];
                
                const tipo = this.tiposFormulario[this.tipoAtual];
                document.getElementById('tituloColetaAtual').textContent = `Coleta: ${nome}`;
                document.getElementById('breadcrumbColeta').textContent = nome;
                document.getElementById('contadorItens').textContent = this.dadosAtuais.length;
                
                this.renderizarFormulario();
                this.mostrarTela('telaDadosColeta');
            }

            async excluirColecao(nome) {
                const confirmar = await this.abrirModalConfirmacao(
                    'Excluir Coleta',
                    `Deseja realmente excluir a coleta "${nome}"?`
                );
                
                if (confirmar) {
                    delete this.colecoes[this.tipoAtual][nome];
                    this.salvarDados();
                    this.renderizarListaColecoes();
                    this.renderizarHub();
                    this.mostrarMensagem(`Coleta "${nome}" exclu√≠da`);
                }
            }

            renderizarListaColecoes() {
                const lista = document.getElementById('listaColetas');
                lista.innerHTML = '';
                
                const colecoesTipo = this.colecoes[this.tipoAtual] || {};
                const nomes = Object.keys(colecoesTipo);
                
                if (nomes.length === 0) {
                    lista.innerHTML = '<p class="text-center">Nenhuma coleta criada ainda.</p>';
                    return;
                }
                
                nomes.forEach(nome => {
                    const qtdItens = colecoesTipo[nome].length;
                    const item = document.createElement('div');
                    item.className = 'item-coleta';
                    item.innerHTML = `
                        <div class="item-coleta-info">
                            <span class="item-coleta-nome">${this.escaparHTML(nome)}</span>
                            <span class="item-coleta-contador">
                                ${qtdItens} ${qtdItens === 1 ? 'item' : 'itens'}
                            </span>
                        </div>
                        <div class="item-coleta-acoes">
                            <button onclick="sistema.abrirColecao('${this.escaparHTML(nome)}')" class="btn-primary btn-sm">
                                üìÇ Acessar
                            </button>
                            <button onclick="sistema.exportarDiretoCSV('${this.escaparHTML(nome)}')" class="btn-success btn-sm">
                                üíæ Exportar
                            </button>
                            <button onclick="sistema.visualizarColecao('${this.escaparHTML(nome)}')" class="btn-secondary btn-sm">
                                üëÅÔ∏è Ver
                            </button>
                            <button onclick="sistema.excluirColecao('${this.escaparHTML(nome)}')" class="btn-danger btn-sm">
                                üóëÔ∏è
                            </button>
                        </div>
                    `;
                    lista.appendChild(item);
                });
            }

            // ===========================================================================
            // RENDERIZA√á√ÉO DIN√ÇMICA DO FORMUL√ÅRIO
            // ===========================================================================
            
            renderizarFormulario() {
                const tipo = this.tiposFormulario[this.tipoAtual];
                const container = document.getElementById('camposFormulario');
                container.innerHTML = '';
                
                tipo.campos.forEach(campo => {
                    const wrapper = document.createElement('div');
                    wrapper.className = campo.fullWidth ? 'full-width' : '';
                    
                    if (campo.tipo === 'select-dinamico' || campo.tipo === 'select-historico') {
                        wrapper.classList.add('campo-combo');
                    }
                    
                    let html = `
                        <label for="${campo.id}">
                            ${campo.label}:${campo.obrigatorio ? '<span style="color: red;">*</span>' : ''}
                        </label>
                    `;
                    
                    switch (campo.tipo) {
                        case 'text':
                        case 'number':
                            html += `
                                <input type="${campo.tipo}" 
                                       id="${campo.id}" 
                                       ${campo.obrigatorio ? 'required' : ''}
                                       ${campo.placeholder ? `placeholder="${campo.placeholder}"` : ''}>
                            `;
                            break;
                            
                        case 'textarea':
                            html += `
                                <textarea id="${campo.id}" 
                                          rows="3"
                                          ${campo.obrigatorio ? 'required' : ''}></textarea>
                            `;
                            break;
                            
                        case 'select':
                            html += `
                                <select id="${campo.id}" ${campo.obrigatorio ? 'required' : ''}>
                                    <option value="">Selecione...</option>
                                    ${campo.opcoes.map(op => `<option value="${op}">${op}</option>`).join('')}
                                </select>
                            `;
                            break;
                            
                        case 'select-dinamico':
                            html += `
                                <select id="${campo.id}" ${campo.obrigatorio ? 'required' : ''}>
                                    <option value="">Selecione ${campo.dependeDe || ''} primeiro...</option>
                                </select>
                            `;
                            if (campo.permitirOutro) {
                                html += `
                                    <div id="${campo.id}ManualContainer" class="input-manual">
                                        <label class="label-manual">Digite ${campo.label.toLowerCase()}:</label>
                                        <input type="text" id="${campo.id}Manual" placeholder="Ex: NOVO VALOR">
                                    </div>
                                `;
                            }
                            break;
                            
                        case 'select-historico':
                            html += `
                                <select id="${campo.id}" ${campo.obrigatorio ? 'required' : ''}>
                                    <option value="">Digite ou selecione...</option>
                                </select>
                            `;
                            if (campo.permitirOutro) {
                                html += `
                                    <div id="${campo.id}ManualContainer" class="input-manual">
                                        <label class="label-manual">Digite ${campo.label.toLowerCase()}:</label>
                                        <input type="text" id="${campo.id}Manual" placeholder="Ex: NOVO VALOR">
                                    </div>
                                `;
                            }
                            break;
                    }
                    
                    if (campo.dica) {
                        html += `<div class="dica">${campo.dica}</div>`;
                    }
                    
                    wrapper.innerHTML = html;
                    container.appendChild(wrapper);
                });
                
                this.configurarEventosCampos();
                this.renderizarCabecalhoTabela();
            }

            configurarEventosCampos() {
                const tipo = this.tiposFormulario[this.tipoAtual];
                
                tipo.campos.forEach(campo => {
                    const elemento = document.getElementById(campo.id);
                    if (!elemento) return;
                    
                    // Converter para mai√∫sculas em inputs de texto
                    if (campo.tipo === 'text') {
                        elemento.addEventListener('input', () => {
                            elemento.value = elemento.value.toUpperCase();
                        });
                    }
                    
                    // Configurar select-dinamico
                    if (campo.tipo === 'select-dinamico') {
                        if (campo.dependeDe === 'tipo') {
                            // Campo tipo -> atualiza marcas
                            const tipoSelect = document.getElementById('tipo');
                            if (tipoSelect) {
                                tipoSelect.addEventListener('change', () => this.atualizarMarcas());
                            }
                        }
                        
                        if (campo.id === 'marca') {
                            elemento.addEventListener('change', () => this.atualizarModelos());
                        }
                        
                        if (campo.permitirOutro) {
                            elemento.addEventListener('change', () => {
                                this.tratarSelecaoOutro(campo.id);
                            });
                            
                            const manual = document.getElementById(`${campo.id}Manual`);
                            if (manual) {
                                manual.addEventListener('input', () => {
                                    manual.value = manual.value.toUpperCase();
                                });
                            }
                        }
                    }
                    
                    // Configurar select-historico
                    if (campo.tipo === 'select-historico') {
                        this.atualizarSelectHistorico(campo.id, campo.historicoKey);
                        
                        if (campo.permitirOutro) {
                            elemento.addEventListener('change', () => {
                                this.tratarSelecaoOutro(campo.id);
                            });
                            
                            const manual = document.getElementById(`${campo.id}Manual`);
                            if (manual) {
                                manual.addEventListener('input', () => {
                                    manual.value = manual.value.toUpperCase();
                                });
                            }
                        }
                    }
                });
            }

            // ===========================================================================
            // CAMPOS DIN√ÇMICOS - MARCA/MODELO
            // ===========================================================================
            
            obterMarcas(tipoEquipamento) {
                const tipo = this.tiposFormulario[this.tipoAtual];
                if (!tipo.baseDados || !tipoEquipamento) return [];
                
                const marcasBase = Object.keys(tipo.baseDados[tipoEquipamento] || {});
                const marcasPers = Object.keys(this.dadosPersonalizados[this.tipoAtual]?.[tipoEquipamento] || {});
                
                return [...new Set([...marcasBase, ...marcasPers])].sort();
            }

            obterModelos(tipoEquipamento, marca) {
                const tipo = this.tiposFormulario[this.tipoAtual];
                if (!tipo.baseDados || !tipoEquipamento || !marca) return [];
                
                const modelosBase = tipo.baseDados[tipoEquipamento]?.[marca] || [];
                const modelosPers = this.dadosPersonalizados[this.tipoAtual]?.[tipoEquipamento]?.[marca] || [];
                
                return [...new Set([...modelosBase, ...modelosPers])].sort();
            }

            atualizarMarcas() {
                const tipoSelect = document.getElementById('tipo');
                const marcaSelect = document.getElementById('marca');
                const modeloSelect = document.getElementById('modelo');
                
                if (!tipoSelect || !marcaSelect) return;
                
                const tipoEquip = tipoSelect.value;
                
                // Reset
                marcaSelect.innerHTML = '<option value="">Selecione...</option>';
                if (modeloSelect) {
                    modeloSelect.innerHTML = '<option value="">Selecione a marca primeiro...</option>';
                }
                
                const containerMarcaManual = document.getElementById('marcaManualContainer');
                const containerModeloManual = document.getElementById('modeloManualContainer');
                if (containerMarcaManual) containerMarcaManual.classList.remove('visivel');
                if (containerModeloManual) containerModeloManual.classList.remove('visivel');
                
                if (!tipoEquip) return;
                
                const marcas = this.obterMarcas(tipoEquip);
                
                marcas.forEach(marca => {
                    const option = document.createElement('option');
                    option.value = marca;
                    option.textContent = marca;
                    marcaSelect.appendChild(option);
                });
                
                // Adicionar op√ß√£o "Outro..."
                const optOutro = document.createElement('option');
                optOutro.value = 'OUTRO';
                optOutro.textContent = '‚ûï Outro...';
                optOutro.style.fontWeight = 'bold';
                optOutro.style.color = '#6366f1';
                marcaSelect.appendChild(optOutro);
            }

            atualizarModelos() {
                const tipoSelect = document.getElementById('tipo');
                const marcaSelect = document.getElementById('marca');
                const modeloSelect = document.getElementById('modelo');
                
                if (!tipoSelect || !marcaSelect || !modeloSelect) return;
                
                const tipoEquip = tipoSelect.value;
                const marca = marcaSelect.value;
                
                modeloSelect.innerHTML = '<option value="">Selecione...</option>';
                
                const containerModeloManual = document.getElementById('modeloManualContainer');
                if (containerModeloManual) containerModeloManual.classList.remove('visivel');
                
                if (marca === 'OUTRO') {
                    this.tratarSelecaoOutro('marca');
                    return;
                }
                
                if (!tipoEquip || !marca) return;
                
                const modelos = this.obterModelos(tipoEquip, marca);
                
                modelos.forEach(modelo => {
                    const option = document.createElement('option');
                    option.value = modelo;
                    option.textContent = modelo;
                    modeloSelect.appendChild(option);
                });
                
                // Adicionar op√ß√£o "Outro..."
                const optOutro = document.createElement('option');
                optOutro.value = 'OUTRO';
                optOutro.textContent = '‚ûï Outro...';
                optOutro.style.fontWeight = 'bold';
                optOutro.style.color = '#6366f1';
                modeloSelect.appendChild(optOutro);
            }

            // ===========================================================================
            // CAMPOS DIN√ÇMICOS - HIST√ìRICO (SETOR/LOCAL)
            // ===========================================================================
            
            atualizarSelectHistorico(campoId, historicoKey) {
                const select = document.getElementById(campoId);
                if (!select) return;
                
                const historicoDados = this.historico[this.tipoAtual]?.[historicoKey] || {};
                const ordenados = Object.entries(historicoDados)
                    .sort((a, b) => b[1] - a[1]);
                
                select.innerHTML = '<option value="">Digite ou selecione...</option>';
                
                if (ordenados.length > 0) {
                    // Top 5
                    ordenados.slice(0, 5).forEach(([valor, freq]) => {
                        const option = document.createElement('option');
                        option.value = valor;
                        option.textContent = valor;
                        select.appendChild(option);
                    });
                    
                    // Resto
                    if (ordenados.length > 5) {
                        const optgroup = document.createElement('optgroup');
                        optgroup.label = '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ';
                        select.appendChild(optgroup);
                        
                        ordenados.slice(5).forEach(([valor]) => {
                            const option = document.createElement('option');
                            option.value = valor;
                            option.textContent = valor;
                            select.appendChild(option);
                        });
                    }
                }
                
                // Op√ß√£o "Outro..."
                const optOutro = document.createElement('option');
                optOutro.value = 'OUTRO';
                optOutro.textContent = '‚ûï Outro...';
                optOutro.style.fontWeight = 'bold';
                optOutro.style.color = '#6366f1';
                select.appendChild(optOutro);
            }

            adicionarHistorico(historicoKey, valor) {
                if (!valor || !this.tipoAtual) return;
                
                valor = valor.toUpperCase().trim();
                
                if (!this.historico[this.tipoAtual]) {
                    this.historico[this.tipoAtual] = { setores: {}, locais: {} };
                }
                
                if (!this.historico[this.tipoAtual][historicoKey]) {
                    this.historico[this.tipoAtual][historicoKey] = {};
                }
                
                this.historico[this.tipoAtual][historicoKey][valor] = 
                    (this.historico[this.tipoAtual][historicoKey][valor] || 0) + 1;
                
                this.salvarHistorico();
            }

            // ===========================================================================
            // TRATAMENTO DE "OUTRO..."
            // ===========================================================================
            
            tratarSelecaoOutro(campoId) {
                const select = document.getElementById(campoId);
                const container = document.getElementById(`${campoId}ManualContainer`);
                const manual = document.getElementById(`${campoId}Manual`);
                
                if (!select || !container) return;
                
                if (select.value === 'OUTRO') {
                    container.classList.add('visivel');
                    if (manual) {
                        manual.focus();
                    }
                } else {
                    container.classList.remove('visivel');
                    if (manual) manual.value = '';
                }
            }

            // ===========================================================================
            // CRUD DE ITENS
            // ===========================================================================
            
            salvarItem(evento) {
                evento.preventDefault();
                
                const tipo = this.tiposFormulario[this.tipoAtual];
                const item = {};
                
                // Coletar valores dos campos
                tipo.campos.forEach(campo => {
                    const select = document.getElementById(campo.id);
                    const manual = document.getElementById(`${campo.id}Manual`);
                    
                    let valor = '';
                    
                    if (select) {
                        if ((campo.tipo === 'select-dinamico' || campo.tipo === 'select-historico') 
                            && campo.permitirOutro && select.value === 'OUTRO') {
                            valor = manual?.value?.trim() || '';
                        } else {
                            valor = select.value?.trim() || '';
                        }
                    }
                    
                    // Normalizar para mai√∫sculas
                    if (typeof valor === 'string' && campo.tipo !== 'number') {
                        valor = valor.toUpperCase();
                    }
                    
                    item[campo.id] = valor;
                });

                // Valida√ß√µes obrigat√≥rias
                for (let campo of tipo.campos) {
                    if (campo.obrigatorio && !item[campo.id]) {
                        this.mostrarMensagem(`Preencha o campo ${campo.label}`, 'erro');
                        return;
                    }
                }

                // Valida√ß√£o customizada do tipo
                if (tipo.validarItem) {
                    const resultado = tipo.validarItem(item);
                    if (!resultado.valido) {
                        this.mostrarMensagem(resultado.erro, 'erro');
                        return;
                    }
                }

                // Adicionar dados personalizados (marca/modelo)
                if (item.tipo && item.marca) {
                    this.adicionarDadoPersonalizado(item.tipo, item.marca, item.modelo);
                }
                
                // Adicionar ao hist√≥rico
                if (item.setor) this.adicionarHistorico('setores', item.setor);
                if (item.local) this.adicionarHistorico('locais', item.local);

                // Salvar
                if (this.indiceEdicao === -1) {
                    this.dadosAtuais.push(item);
                    this.mostrarMensagem('Item adicionado com sucesso!');
                } else {
                    this.dadosAtuais[this.indiceEdicao] = item;
                    this.mostrarMensagem('Item atualizado com sucesso!');
                    this.indiceEdicao = -1;
                    document.getElementById('btnSalvarItem').innerHTML = '‚ûï Adicionar Item';
                }

                this.colecoes[this.tipoAtual][this.colecaoAtual] = this.dadosAtuais;
                this.salvarDados();
                
                // Atualizar listas
                this.atualizarSelectHistorico('setor', 'setores');
                this.atualizarSelectHistorico('local', 'locais');
                
                this.limparFormulario();
                document.getElementById('contadorItens').textContent = this.dadosAtuais.length;
                this.renderizarHub();
            }

            adicionarDadoPersonalizado(tipoEquip, marca, modelo) {
                if (!tipoEquip || !marca) return;
                
                marca = marca.toUpperCase();
                
                if (!this.dadosPersonalizados[this.tipoAtual]) {
                    this.dadosPersonalizados[this.tipoAtual] = {};
                }
                
                if (!this.dadosPersonalizados[this.tipoAtual][tipoEquip]) {
                    this.dadosPersonalizados[this.tipoAtual][tipoEquip] = {};
                }
                
                if (!this.dadosPersonalizados[this.tipoAtual][tipoEquip][marca]) {
                    this.dadosPersonalizados[this.tipoAtual][tipoEquip][marca] = [];
                }
                
                if (modelo && !this.dadosPersonalizados[this.tipoAtual][tipoEquip][marca].includes(modelo)) {
                    this.dadosPersonalizados[this.tipoAtual][tipoEquip][marca].push(modelo);
                    this.salvarDadosPersonalizados();
                }
            }

            editarItem(indice) {
                const item = this.dadosAtuais[indice];
                const tipoConfig = this.tiposFormulario[this.tipoAtual];
                
                this.indiceEdicao = indice;
                document.getElementById('btnSalvarItem').innerHTML = '‚úèÔ∏è Atualizar Item';
                this.mostrarAba('formulario');
                
                // Preencher campos em sequ√™ncia com Promises para garantir ordem
                this.preencherCamposEdicao(item, tipoConfig);
                this.mostrarMensagem('Editando item...');
            }

            async preencherCamposEdicao(item, tipoConfig) {
                // 1. Preencher campo TIPO primeiro (dispara atualiza√ß√£o de marcas)
                const tipoEl = document.getElementById('tipo');
                if (tipoEl && item.tipo) {
                    tipoEl.value = item.tipo;
                    this.atualizarMarcas();
                }
                
                // Aguardar DOM atualizar
                await this.aguardar(100);
                
                // 2. Preencher MARCA (dispara atualiza√ß√£o de modelos)
                const marcaEl = document.getElementById('marca');
                if (marcaEl && item.marca) {
                    const marcaExiste = Array.from(marcaEl.options).some(opt => opt.value === item.marca);
                    
                    if (marcaExiste) {
                        marcaEl.value = item.marca;
                    } else {
                        marcaEl.value = 'OUTRO';
                        const manual = document.getElementById('marcaManual');
                        const container = document.getElementById('marcaManualContainer');
                        if (manual) manual.value = item.marca;
                        if (container) container.classList.add('visivel');
                    }
                    this.atualizarModelos();
                }
                
                // Aguardar DOM atualizar
                await this.aguardar(100);
                
                // 3. Preencher MODELO
                const modeloEl = document.getElementById('modelo');
                if (modeloEl && item.modelo) {
                    const modeloExiste = Array.from(modeloEl.options).some(opt => opt.value === item.modelo);
                    
                    if (modeloExiste) {
                        modeloEl.value = item.modelo;
                    } else {
                        modeloEl.value = 'OUTRO';
                        const manual = document.getElementById('modeloManual');
                        const container = document.getElementById('modeloManualContainer');
                        if (manual) manual.value = item.modelo;
                        if (container) container.classList.add('visivel');
                    }
                }
                
                // 4. Preencher demais campos (n√£o din√¢micos)
                tipoConfig.campos.forEach(campo => {
                    // Pular campos j√° preenchidos
                    if (['tipo', 'marca', 'modelo'].includes(campo.id)) return;
                    
                    const elemento = document.getElementById(campo.id);
                    if (!elemento) return;
                    
                    const valor = item[campo.id] || '';
                    
                    if (campo.tipo === 'select-historico') {
                        const existe = Array.from(elemento.options).some(opt => opt.value === valor);
                        if (existe && valor) {
                            elemento.value = valor;
                        } else if (valor) {
                            elemento.value = 'OUTRO';
                            const manual = document.getElementById(`${campo.id}Manual`);
                            const container = document.getElementById(`${campo.id}ManualContainer`);
                            if (manual) manual.value = valor;
                            if (container) container.classList.add('visivel');
                        }
                    } else {
                        elemento.value = valor;
                    }
                });
            }

            aguardar(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }

            async excluirItem(indice) {
                const confirmar = await this.abrirModalConfirmacao(
                    'Excluir Item',
                    'Deseja realmente excluir este item?'
                );
                
                if (confirmar) {
                    this.dadosAtuais.splice(indice, 1);
                    this.colecoes[this.tipoAtual][this.colecaoAtual] = this.dadosAtuais;
                    this.salvarDados();
                    this.renderizarTabela();
                    this.renderizarHub();
                    document.getElementById('contadorItens').textContent = this.dadosAtuais.length;
                    this.mostrarMensagem('Item exclu√≠do');
                }
            }

            async limparTodos() {
                const confirmar = await this.abrirModalConfirmacao(
                    'Limpar Todos',
                    'ATEN√á√ÉO: Isso apagar√° TODOS os itens desta coleta. Continuar?'
                );
                
                if (confirmar) {
                    this.dadosAtuais = [];
                    this.colecoes[this.tipoAtual][this.colecaoAtual] = this.dadosAtuais;
                    this.salvarDados();
                    this.renderizarTabela();
                    this.renderizarHub();
                    document.getElementById('contadorItens').textContent = 0;
                    this.mostrarMensagem('Todos os itens foram removidos', 'erro');
                }
            }

            limparFormulario() {
                document.getElementById('formularioCadastro').reset();
                
                // Ocultar todos os containers manuais
                document.querySelectorAll('.input-manual').forEach(el => {
                    el.classList.remove('visivel');
                });
                
                this.indiceEdicao = -1;
                document.getElementById('btnSalvarItem').innerHTML = '‚ûï Adicionar Item';
            }

            // ===========================================================================
            // TABELA
            // ===========================================================================
            
            renderizarCabecalhoTabela() {
                const tipo = this.tiposFormulario[this.tipoAtual];
                const thead = document.getElementById('cabecalhoTabela');
                
                let html = '<tr>';
                tipo.colunas.forEach(col => {
                    html += `<th>${col.label}</th>`;
                });
                html += '<th class="text-center">A√ß√µes</th></tr>';
                
                thead.innerHTML = html;
            }

            renderizarTabela() {
                const tipo = this.tiposFormulario[this.tipoAtual];
                const corpo = document.getElementById('corpoTabela');
                corpo.innerHTML = '';
                
                if (this.dadosAtuais.length === 0) {
                    corpo.innerHTML = `<tr><td colspan="${tipo.colunas.length + 1}" class="text-center">Nenhum item registrado</td></tr>`;
                    return;
                }
                
                this.dadosAtuais.forEach((item, indice) => {
                    const linha = corpo.insertRow();
                    
                    tipo.colunas.forEach(col => {
                        const celula = linha.insertCell();
                        celula.textContent = item[col.id] || '';
                    });
                    
                    const celulaAcoes = linha.insertCell();
                    celulaAcoes.className = 'text-center';
                    celulaAcoes.innerHTML = `
                        <button onclick="sistema.editarItem(${indice})" class="btn-secondary btn-sm">Editar</button>
                        <button onclick="sistema.excluirItem(${indice})" class="btn-danger btn-sm">Excluir</button>
                    `;
                });
            }

            // ===========================================================================
            // EXPORTA√á√ÉO
            // ===========================================================================
            
            exportarColecao(nomeColecao) {
                const dados = this.colecoes[this.tipoAtual][nomeColecao || this.colecaoAtual] || [];
                const tipo = this.tiposFormulario[this.tipoAtual];
                
                if (dados.length === 0) {
                    this.mostrarMensagem('Nenhum dado para exportar', 'erro');
                    return;
                }
                
                const cabecalhos = tipo.colunas.map(c => c.label);
                let csv = '\uFEFF' + cabecalhos.join(';') + '\n';
                
                dados.forEach(item => {
                    const linha = tipo.colunas.map(col => this.escaparCSV(item[col.id])).join(';');
                    csv += linha + '\n';
                });
                
                document.getElementById('textoCSV').value = csv;
                document.getElementById('containerCSV').classList.remove('oculto');
                this.mostrarMensagem('Dados prontos para exporta√ß√£o');
            }

            exportarDiretoCSV(nomeColecao) {
                const dados = this.colecoes[this.tipoAtual][nomeColecao] || [];
                const tipo = this.tiposFormulario[this.tipoAtual];
                
                if (dados.length === 0) {
                    this.mostrarMensagem('Esta coleta n√£o possui itens para exportar', 'erro');
                    return;
                }
                
                const cabecalhos = tipo.colunas.map(c => c.label);
                let csv = '\uFEFF' + cabecalhos.join(';') + '\n';
                
                dados.forEach(item => {
                    const linha = tipo.colunas.map(col => this.escaparCSV(item[col.id])).join(';');
                    csv += linha + '\n';
                });
                
                const nomeArquivo = `${this.tipoAtual}_${nomeColecao}_${new Date().toISOString().split('T')[0]}.csv`;
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = nomeArquivo;
                link.click();
                
                this.mostrarMensagemFlutuante(`‚úÖ CSV "${nomeColecao}" baixado com sucesso!`, 'sucesso');
            }

            async visualizarColecao(nomeColecao) {
                const dados = this.colecoes[this.tipoAtual][nomeColecao] || [];
                const tipo = this.tiposFormulario[this.tipoAtual];
                
                if (dados.length === 0) {
                    this.mostrarMensagem('Esta coleta n√£o possui itens', 'erro');
                    return;
                }
                
                const resumo = { total: dados.length, porCampo: {} };
                
                // Analisar campos relevantes
                ['tipo', 'predio', 'setor'].forEach(campoId => {
                    if (tipo.colunas.some(c => c.id === campoId)) {
                        resumo.porCampo[campoId] = {};
                        dados.forEach(item => {
                            const valor = item[campoId] || 'N√ÉO INFORMADO';
                            resumo.porCampo[campoId][valor] = (resumo.porCampo[campoId][valor] || 0) + 1;
                        });
                    }
                });
                
                let mensagemResumo = `üìä RESUMO DA COLETA "${nomeColecao}"\n\n`;
                mensagemResumo += `Total de itens: ${resumo.total}\n\n`;
                
                for (let campo in resumo.porCampo) {
                    const coluna = tipo.colunas.find(c => c.id === campo);
                    mensagemResumo += `Por ${coluna?.label || campo}:\n`;
                    Object.entries(resumo.porCampo[campo])
                        .sort((a, b) => b[1] - a[1])
                        .slice(0, 5)
                        .forEach(([valor, qtd]) => {
                            mensagemResumo += `  ‚Ä¢ ${valor}: ${qtd}\n`;
                        });
                    mensagemResumo += '\n';
                }
                
                await this.abrirModalVisualizacao('Visualiza√ß√£o da Coleta', mensagemResumo);
            }

            copiarCSV() {
                const textarea = document.getElementById('textoCSV');
                textarea.select();
                document.execCommand('copy');
                this.mostrarMensagem('CSV copiado!');
            }

            baixarCSV() {
                const csv = document.getElementById('textoCSV').value;
                const nome = `${this.tipoAtual}_${this.colecaoAtual}_${new Date().toISOString().split('T')[0]}.csv`;
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = nome;
                link.click();
                this.mostrarMensagem('Arquivo baixado!');
            }

            // ===========================================================================
            // UTILIT√ÅRIOS
            // ===========================================================================
            
            escaparHTML(str) {
                if (!str) return '';
                const div = document.createElement('div');
                div.textContent = str;
                return div.innerHTML;
            }

            escaparCSV(valor) {
                if (!valor) return '';
                const str = String(valor);
                if (str.includes(';') || str.includes('"') || str.includes('\n')) {
                    return `"${str.replace(/"/g, '""')}"`;
                }
                return str;
            }

            mostrarMensagem(texto, tipo = 'sucesso') {
                const mensagem = document.getElementById('mensagem');
                mensagem.textContent = texto;
                mensagem.className = `mensagem ${tipo} visivel`;
                setTimeout(() => mensagem.classList.remove('visivel'), 3000);
            }

            mostrarMensagemFlutuante(texto, tipo = 'sucesso') {
                const msgElement = document.createElement('div');
                msgElement.className = `mensagem ${tipo} visivel msg-flutuante`;
                msgElement.textContent = texto;
                document.body.appendChild(msgElement);
                
                setTimeout(() => {
                    msgElement.style.animation = 'slideOut 0.3s ease-out';
                    setTimeout(() => msgElement.remove(), 300);
                }, 3000);
            }

            // ===========================================================================
            // MODAIS
            // ===========================================================================
            
            abrirModalInput(titulo, mensagem) {
                return new Promise((resolver) => {
                    const modal = document.getElementById('modal');
                    document.getElementById('modalTitulo').textContent = titulo;
                    document.getElementById('modalMensagem').textContent = mensagem;
                    
                    const input = document.getElementById('modalInput');
                    input.style.display = 'block';
                    input.value = '';
                    
                    modal.classList.add('ativo');
                    input.focus();
                    
                    document.getElementById('modalBtnConfirmar').onclick = () => {
                        modal.classList.remove('ativo');
                        resolver(input.value.trim());
                    };
                    
                    document.getElementById('modalBtnCancelar').onclick = () => {
                        modal.classList.remove('ativo');
                        resolver(null);
                    };
                });
            }

            abrirModalConfirmacao(titulo, mensagem) {
                return new Promise((resolver) => {
                    const modal = document.getElementById('modal');
                    document.getElementById('modalTitulo').textContent = titulo;
                    document.getElementById('modalMensagem').textContent = mensagem;
                    document.getElementById('modalInput').style.display = 'none';
                    
                    modal.classList.add('ativo');
                    
                    document.getElementById('modalBtnConfirmar').onclick = () => {
                        modal.classList.remove('ativo');
                        resolver(true);
                    };
                    
                    document.getElementById('modalBtnCancelar').onclick = () => {
                        modal.classList.remove('ativo');
                        resolver(false);
                    };
                });
            }

            abrirModalVisualizacao(titulo, mensagem) {
                return new Promise((resolver) => {
                    const modal = document.getElementById('modal');
                    document.getElementById('modalTitulo').textContent = titulo;
                    const modalMsg = document.getElementById('modalMensagem');
                    modalMsg.textContent = mensagem;
                    modalMsg.style.whiteSpace = 'pre-line';
                    modalMsg.style.textAlign = 'left';
                    modalMsg.style.fontSize = '0.875rem';
                    modalMsg.style.maxHeight = '400px';
                    modalMsg.style.overflowY = 'auto';
                    document.getElementById('modalInput').style.display = 'none';
                    
                    document.getElementById('modalBtnCancelar').style.display = 'none';
                    document.getElementById('modalBtnConfirmar').textContent = 'Fechar';
                    
                    modal.classList.add('ativo');
                    
                    document.getElementById('modalBtnConfirmar').onclick = () => {
                        modal.classList.remove('ativo');
                        document.getElementById('modalBtnCancelar').style.display = '';
                        document.getElementById('modalBtnConfirmar').textContent = 'Confirmar';
                        modalMsg.style = '';
                        resolver(true);
                    };
                });
            }

            // ===========================================================================
            // PWA
            // ===========================================================================
            
            configurarPWA() {
                if ('serviceWorker' in navigator) {
                    navigator.serviceWorker.register('sw.js')
                        .then(() => console.log('Service Worker registrado'))
                        .catch(err => console.log('Erro no SW:', err));
                }

                window.addEventListener('beforeinstallprompt', (e) => {
                    e.preventDefault();
                    this.promptInstalacao = e;
                    document.getElementById('promptInstalacao').classList.add('visivel');
                });

                const atualizarStatus = () => {
                    const statusEl = document.getElementById('statusPWA');
                    const textoEl = document.getElementById('textoStatus');
                    
                    if (navigator.onLine) {
                        textoEl.textContent = 'üü¢ Online';
                        statusEl.className = 'status-pwa online';
                    } else {
                        textoEl.textContent = 'üî¥ Offline';
                        statusEl.className = 'status-pwa offline';
                    }
                    
                    statusEl.style.display = 'block';
                    setTimeout(() => statusEl.style.display = 'none', 3000);
                };

                window.addEventListener('online', atualizarStatus);
                window.addEventListener('offline', atualizarStatus);
            }

            // ===========================================================================
            // EVENTOS GLOBAIS
            // ===========================================================================
            
            configurarEventosGlobais() {
                // Navega√ß√£o
                document.getElementById('btnNovaColeta').addEventListener('click', () => this.criarColecao());
                document.getElementById('btnListarColetas').addEventListener('click', () => this.irParaListaColetas());
                document.getElementById('btnVoltarPrincipal').addEventListener('click', () => this.voltarPrincipal());
                document.getElementById('btnInicio').addEventListener('click', () => this.irParaHub());
                document.getElementById('btnTodasColetas').addEventListener('click', () => this.irParaListaColetas());

                // Abas
                document.getElementById('abaFormulario').addEventListener('click', () => this.mostrarAba('formulario'));
                document.getElementById('abaTabela').addEventListener('click', () => this.mostrarAba('tabela'));

                // Formul√°rio
                document.getElementById('formularioCadastro').addEventListener('submit', (e) => this.salvarItem(e));
                document.getElementById('btnLimparForm').addEventListener('click', () => this.limparFormulario());

                // Tabela
                document.getElementById('btnExportarCSV').addEventListener('click', () => this.exportarColecao());
                document.getElementById('btnLimparTodos').addEventListener('click', () => this.limparTodos());
                document.getElementById('btnCopiarCSV').addEventListener('click', () => this.copiarCSV());
                document.getElementById('btnBaixarCSV').addEventListener('click', () => this.baixarCSV());

                // Modal
                document.querySelector('.modal-fechar').addEventListener('click', () => {
                    document.getElementById('modal').classList.remove('ativo');
                });

                // PWA
                document.getElementById('btnInstalar').addEventListener('click', async () => {
                    if (this.promptInstalacao) {
                        this.promptInstalacao.prompt();
                        const { outcome } = await this.promptInstalacao.userChoice;
                        if (outcome === 'accepted') {
                            document.getElementById('promptInstalacao').classList.remove('visivel');
                        }
                        this.promptInstalacao = null;
                    }
                });

                document.getElementById('btnFecharPrompt').addEventListener('click', () => {
                    document.getElementById('promptInstalacao').classList.remove('visivel');
                });
            }
        }

        // Inicializa√ß√£o
        const sistema = new SistemaColetas();
    </script>
</body>
</html>
